function [Y,Xf,Af] = psp_fan2_v2(X,~,~)
%MYNEURALNETWORKFUNCTION neural network simulation function.
% 50 nodes, Neural Fitting, LM optimization
% X = [vav1, vav2, Tz1act-Tz1sp, Tz2act-Tz2sp,Psp2Old];
% Auto-generated by MATLAB, 24-Jul-2023 14:33:32.
%
% [Y] = myNeuralNetworkFunction(X,~,~) takes these arguments:
%
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = Qx5 matrix, input #1 at timestep ts.
%
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = Qx1 matrix, output #1 at timestep ts.
%
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0;0;-11.8596;-7.5267;98.5];
x1_step1.gain = [0.00234814529689098;0.00189021231053693;0.130248187922086;0.183700274631911;0.00235294117647059];
x1_step1.ymin = -1;

% Layer 1
b1 = [2.8253559828545316002;-2.2706264756333234267;-3.6338897046759512932;-2.1611383425022885341;-2.7279178007162334652;2.6654728638226146131;-2.823223146502419123;1.3902104409178852595;1.2821827806059051813;-2.0016567292755498286;1.7432436876935870629;-2.1428571448064603899;-0.21066686331092432383;0.22804121617824368862;0.79904597320263548443;0.58525821010476475337;-1.8282345071316168372;-0.58731835435230361764;-0.38763651997882464517;-0.79687539506611104745;-0.34212763768175696866;-0.51472673987211747804;0.49621895809665206301;-0.10976872168585542766;0.32294119051770481255;0.10667121350538888436;-0.24807209786433717658;0.93824519002895656605;-0.63135425352149343592;-0.19074595577981148797;-0.99229910852616709516;-0.051124935539416820063;0.62807976308205992755;0.73149450989740771867;0.58597460425134617612;1.4553835429184285299;1.3429960026492320235;-2.2540009844201107647;-2.4155263080707993772;0.92067893292916980208;-0.71801219185528664113;2.5873744632115189823;2.6077530451258272848;2.5143875603809231478;-1.8994637826516478363;-2.0131317046062311427;-2.2671377476224696679;-1.9349755104040178288;-2.6843625886925965851;3.6024542921854627586];
IW1_1 = [0.40572825646214250028 1.3990577384089581958 -1.5514434786296136259 0.82666473009452345888 1.1931989070111239659;1.1611923948755065172 0.926720505151866214 1.1691390507487275929 0.85946473207849627407 -1.6390219903423013381;1.407238522147266524 -0.8965443788547645676 -0.9557191128319139084 -1.1158984894305559177 1.8432978392853127669;-0.96023955091230039915 -0.26168775089616486129 -0.67359848493752272347 0.73561243824956101811 1.650621761109304142;1.6721429225858297496 -1.5483029078004217904 -0.73438948083040422876 0.69864605593893136515 1.6227315919366109842;0.37524393263947075638 -1.1719481317687152622 0.03808733537825568366 1.9081557657441996501 2.4041210955407139593;0.30129342523785873631 0.84961886187766055833 -0.41256274098602802036 1.4577610052007601293 2.1495028508280640267;-1.0197654360496679615 -1.8497285289034606226 1.0097590707983179481 2.116882442571117906 -0.78622048507238839754;-0.64890262128804243602 1.3086828463670940881 -2.3446132723578276824 1.3263154264896619416 -0.17930885354369069384;1.7322077921965932656 0.68084520172202667165 -1.8509482617119368264 2.6056379059084373573 -1.9219557351666691769;-0.5426146444448156636 0.084611703375457605891 1.5854482254802413355 -1.4336339263399404675 1.405444187622676866;1.5422172167634664586 -1.5375040722213244582 -2.9304968571465614957 -0.28521870408927818552 2.0733196023313764655;-0.62306599999741574258 -0.74587304059527814726 -0.69085280643821789237 1.4634200949570139727 -0.24557721115928549116;-0.26363222781955164553 -0.14494391041119256136 -0.067854731026154441187 2.9456598209423057178 2.1220071747074253921;-0.014709605866009179895 0.85299478247882665194 -1.1463927981778101461 0.16613366545601623847 0.42630587179232959372;-1.3939360511010876476 -3.1886935575421291311 0.018217439833422058998 -1.0765331022343678224 2.6239707553418671893;1.0977145795442972975 -0.10677965693199069352 1.402961384297703118 -2.2356871248376881667 -2.4952244034691291041;1.4471242528768941682 -1.8129620339417522601 2.2439784699526352796 0.68815242368715345833 0.022604921433394365576;0.97156048562159857962 0.3694595974880292566 -1.1520124126857851365 -0.50386651239123847468 -2.4847595810899361091;1.7241843692201477278 1.7416973187760329544 -0.93990535324769919345 -0.12732087398753560992 2.0087753257124618678;0.43474761212855600467 1.3923874369562279085 0.68393498984667822072 0.17248813778746369119 1.4793084072836601983;2.5480431878783509347 0.30003953344993833374 -0.63961175157365712796 -1.2039197290679763963 -2.260212489400055258;-3.7771845868202738039 0.60354058811914701455 -1.0801858385604596879 -2.9612818520018788782 1.3717108823488153302;-1.5159898303069148096 -1.7015473601785551239 2.0954768943964938721 0.55017066721245622141 -0.10703627230555752547;0.89360532644257961721 -0.90228424693538400447 -1.9709080449357034848 0.97602059663052298522 1.3735345876299085432;-0.22105643280914075155 -0.070563401650175799906 0.85550823764733519017 -0.31118777627834420807 0.24731883099834450768;-1.0799873066933258769 2.0323470717308271816 1.2152419585199261132 0.5309357088831038185 0.39744544676790771742;-0.7900680497785463885 -1.8281306282277300923 0.56528235679058236318 -2.6601920392874864874 2.3863873496131038365;-1.1642585884088709758 -0.92250185645420046399 -1.2188079623853582678 0.67159850701277079565 2.2529225319289070129;-0.0036961145594657561844 0.22030130249948293164 0.18670769339825146749 0.33500874704511318658 -0.48031866011375723424;-2.4176821175593223856 -1.0725125303444975611 -0.44962003233261377266 0.67335427144398063426 -0.26892827492586424132;-1.4389192508822068461 0.80258103820362880487 0.87190137705546433278 -1.4385308893230686067 1.6748374058109221085;-0.047929562934899617999 -2.5437713098114391741 2.7191777699651993316 0.92653158244441291558 -0.46453520360689043445;0.81890700144031614016 -1.4436001411675996042 0.226518917257511887 1.8816600828415470659 -2.1082136237871424989;0.25549265499667211943 0.58361376529620656584 0.58179188471627407697 -2.318577232248165032 -0.5547406114099636687;0.35822785265213075157 -0.43060736786446268676 -1.1618053938837646921 1.7161068662415888131 -0.2638926070802156687;2.3541147395789598917 -1.7505617694618142988 -1.9422430629379501266 -0.3979869203229676744 1.5031972477064250437;0.45456240421667870599 1.8759127449584793723 -0.46775922879370074314 -1.547080993446377839 1.468248936615284439;-1.3029127770696338207 -1.0327050501787169434 -1.8597034346690921591 0.5690645622719366914 1.5179705424154996685;0.40635763768404203899 0.32438616830133804037 -0.1390709528525778671 0.80359065054095935032 0.84178807101106467581;-0.89231054306029466971 -0.020297490106529186144 0.63474834782335920469 -1.8188573724435270762 -0.051075066035216824811;1.4973158636123493626 0.80947147555341769642 -1.332930987932815059 -1.4361588870740762403 -0.56282737030625451524;0.57304363408375691424 2.9798781128755322811 -0.0055104914764678176314 -3.0065235556044842546 0.089701882591445611381;1.1390905940898581328 -0.62391266932242528398 -3.37887370030438694 -1.3105619951194633632 0.77500855433697701802;-1.3507361287662948968 -1.5021415090637080247 0.90369396001763113713 -0.090100200252726858619 -0.59959403621615703361;0.41460572869977657673 1.8028095399587948933 1.30284344785607753 -0.56679880631333479091 1.9964799136098920762;-0.41828639957055235854 1.0811304971976829492 0.32376634919938002133 -2.3527739118443360411 -0.038859171674636171223;0.77558132200465867978 -1.9337655977557872689 -0.60567994512394207618 -0.557674886415300608 -0.34140887367958017151;-1.2843992764595841827 1.2255059977612188238 1.9287974037784436643 -0.19300788660318182743 -1.7968357977299462824;0.24626712797023073143 1.4236929536072848723 0.73219510162195933223 -3.2972008512046060424 1.1206144629266387991];

% Layer 2
b2 = 0.73571578160121020584;
LW2_1 = [0.0075153832295217545129 -0.031068876811380496256 0.4138334821401487007 0.082799152596860908782 0.4527140122498732322 -0.46027004796738130166 0.069597727906522077745 0.13198055735644795283 -0.040525693352143822568 -0.0081930550086927282638 0.066618521845528688718 0.033983589563137697742 -0.025111497941752498886 -0.087994219153171793213 0.10995185620969065432 0.014435242563798368273 -0.0044374874014868042477 0.025890840130276534387 -0.024808751606858883004 -0.014649270617238989781 0.071213602833049269303 -0.03968677318910799473 0.0093873060790440280426 -0.091371827630204335846 0.014412494452786740046 0.31500467592191211397 0.012550450569720350211 -0.019631998984500277639 0.008221495246251441652 -0.62522723871062391154 -0.019298641991181461619 0.044621677698194368855 0.057712476664558393091 -0.040616576577738393306 -0.18496009754598116692 0.012476699036533967641 0.016073760837510595034 0.23990062917793997244 -0.0098848988875801045012 0.59595295153935390342 0.153494113183914066 -0.0053771681526427091147 0.029337272702960291715 0.0091109618624289276378 0.018978855406725527594 0.081560418924278357822 -0.42566827357666359166 0.06851679081946547567 -0.037002465655512205289 -0.012193852078403762465];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = 0.00235294117647059;
y1_step1.xoffset = 98.5;

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX
    X = {X};
end

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},1); % samples/series
else
    Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS
    
    % Input 1
    X{1,ts} = X{1,ts}';
    Xp1 = mapminmax_apply(X{1,ts},x1_step1);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = repmat(b2,1,Q) + LW2_1*a1;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a2,y1_step1);
    Y{1,ts} = Y{1,ts}';
end

% Final Delay States
Xf = cell(1,0);
Af = cell(2,0);

% Format Output Arguments
if ~isCellX
    Y = cell2mat(Y);
end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end
